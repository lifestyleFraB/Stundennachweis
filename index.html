<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stundenabrechnung Busbetrieb Elkmann - Frank Berndt</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg: #0f111a; --card-bg: #1a1c2e; --accent: #7289da;
            --text: #ffffff; --success: #43b581; --danger: #f04747; --text-dim: #949cf7; --edit: #f39c12;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        .app-header { width: 100%; max-width: 850px; padding: 10px; margin-bottom: 10px; border-left: 3px solid var(--accent); font-size: 0.9rem; color: var(--text-dim); }
        .nav { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; width: 100%; max-width: 850px; }
        .nav-btn { flex: 1; min-width: 80px; padding: 12px; cursor: pointer; border-radius: 10px; border: 1px solid var(--accent); background: transparent; color: var(--text); font-weight: bold; font-size: 0.75rem; }
        .nav-btn.active { background: var(--accent); }

        .container { width: 100%; max-width: 850px; display: none; background: var(--card-bg); padding: 20px; border-radius: 15px; box-sizing: border-box; }
        .container.active { display: block; }

        .timer-card { background: linear-gradient(135deg, #2c2f48 0%, #1a1c2e 100%); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; border: 1px solid var(--accent); }
        .timer-display { font-size: 2.5rem; font-weight: bold; font-family: monospace; margin: 10px 0; color: var(--success); }
        
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #2c2f48; color: white; margin-bottom: 15px; box-sizing: border-box; }
        .btn-primary { background: var(--accent); color: white; width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        
        .week-block { background: rgba(255,255,255,0.03); margin-bottom: 25px; border-radius: 12px; border: 1px solid #333; overflow: hidden; }
        .week-title { background: #1f2235; padding: 12px 15px; font-weight: bold; color: var(--accent); }
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .report-table th, .report-table td { padding: 10px; text-align: left; border-bottom: 1px solid #222; }

        .dash-section { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        .dash-section h4 { margin-top: 0; color: var(--accent); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>

<body>

    <h2 style="text-align: center; color: var(--accent); margin-top: 10px;">WorkTrack Elkmann</h2>

    <div class="app-header">
        <strong>Frank Berndt</strong> | Sellen 22 | 48565 Steinfurt
    </div>

    <div class="nav">
        <button id="nav-dash" class="nav-btn active" onclick="showTab('tab-dash')">Dashboard</button>
        <button id="nav-entry" class="nav-btn" onclick="showTab('tab-entry')">Erfassung</button>
        <button id="nav-report" class="nav-btn" onclick="showTab('tab-report')">Bericht</button>
    </div>

    <div id="tab-dash" class="container active">
        <div class="timer-card">
            <h4 style="color:var(--text-dim)">Tour-Stoppuhr</h4>
            <div class="timer-display" id="stopwatch">00:00:00</div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="btn-start" class="btn-primary" style="background:var(--success); width:120px;" onclick="startTimer()">Start</button>
                <button id="btn-stop" class="btn-primary" style="background:var(--danger); width:120px; display:none;" onclick="stopTimer()">Stop</button>
            </div>
            <select id="timer-tour-sel" style="margin-top:15px; margin-bottom:0;"></select>
        </div>

        <div id="dash-summary-content"></div>

        <div class="dash-section">
            <h4>Stundenlohn & Touren</h4>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="number" id="cfg-wage" step="0.01" style="margin-bottom:0;">
                <button onclick="saveWage()" style="background:var(--accent); border:none; padding:0 20px; border-radius:8px; color:white; font-weight:bold;">Lohn Sichern</button>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-tour-name" placeholder="Neue Tour..." style="margin-bottom:0;">
                <button onclick="addTour()" style="background:var(--success); border:none; padding:0 20px; border-radius:8px; color:white; font-weight:bold;">+</button>
            </div>
            <div id="tour-list" style="margin-top:10px; font-size:0.85rem;"></div>
        </div>

        <div class="dash-section" style="border: 1px solid var(--edit);">
            <h4>Backup</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="backupData()" style="background: #444; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">ðŸ’¾ Sichern</button>
                <button onclick="document.getElementById('import-file').click()" style="background: #444; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">ðŸ“‚ Laden</button>
            </div>
            <input type="file" id="import-file" style="display:none" onchange="restoreData(event)" accept=".json">
        </div>
    </div>

    <div id="tab-entry" class="container">
        <h3 id="form-title">Tourzeit erfassen</h3>
        <label>Tour</label><select id="sel-tour"></select>
        <label>Datum</label><input type="date" id="in-date">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label>Vormittag</label><div style="display:flex;gap:5px;"><input type="time" id="am-s" value="00:00"><input type="time" id="am-e" value="00:00"></div></div>
            <div><label>Nachmittag</label><div style="display:flex;gap:5px;"><input type="time" id="pm-s" value="00:00"><input type="time" id="pm-e" value="00:00"></div></div>
        </div>
        <button class="btn-primary" onclick="saveEntry()">Speichern</button>
        <button id="btn-cancel" onclick="resetForm()" style="display:none; width:100%; margin-top:10px; background:#444; color:white; border:none; padding:10px; border-radius:10px;">Abbrechen</button>
    </div>

    <div id="tab-report" class="container">
        <div id="report-list"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
            <button onclick="generatePDF()" style="background:var(--danger); color:white; border:none; padding:15px; border-radius:10px; font-weight:bold;">PDF Beleg (A4)</button>
            <button onclick="exportCSV()" style="background:var(--success); color:white; border:none; padding:15px; border-radius:10px; font-weight:bold;">Excel</button>
        </div>
    </div>

<script>
    let db = JSON.parse(localStorage.getItem('frank_v32')) || { entries: [], tours: ["Standard-Tour"], activeTimer: null, wage: 14.50 };
    let timerInterval;
    let editId = null;

    function init() {
        document.getElementById('cfg-wage').value = db.wage;
        updateTourDropdowns();
        renderDashboard();
        updateTimerUI();
        document.getElementById('in-date').valueAsDate = new Date();
    }

    function saveDB() { localStorage.setItem('frank_v32', JSON.stringify(db)); }

    function backupData() {
        const dataStr = JSON.stringify(db, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `WorkTrack_Backup_${new Date().toISOString().slice(0,10)}.json`;
        link.click();
    }

    function restoreData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (imported.entries) { db = imported; saveDB(); init(); alert("Daten geladen!"); }
            } catch (err) { alert("Fehler!"); }
        };
        reader.readAsText(file);
    }

    function saveWage() { db.wage = parseFloat(document.getElementById('cfg-wage').value.replace(',','.')) || 14.00; saveDB(); renderDashboard(); alert("Gesichert."); }
    function startTimer() { db.activeTimer = { start: Date.now(), tour: document.getElementById('timer-tour-sel').value }; saveDB(); updateTimerUI(); }
    function stopTimer() {
        const startTime = db.activeTimer.start;
        showTab('tab-entry'); document.getElementById('sel-tour').value = db.activeTimer.tour;
        document.getElementById('am-s').value = new Date(startTime).toTimeString().slice(0,5);
        document.getElementById('am-e').value = new Date().toTimeString().slice(0,5);
        db.activeTimer = null; saveDB(); updateTimerUI();
    }
    function updateTimerUI() {
        if(db.activeTimer) {
            document.getElementById('btn-start').style.display = "none"; document.getElementById('btn-stop').style.display = "inline-block";
            if(!timerInterval) timerInterval = setInterval(() => {
                const diff = Date.now() - db.activeTimer.start;
                const h = Math.floor(diff/3600000).toString().padStart(2,'0'), m = Math.floor((diff%3600000)/60000).toString().padStart(2,'0'), s = Math.floor((diff%60000)/1000).toString().padStart(2,'0');
                document.getElementById('stopwatch').innerText = `${h}:${m}:${s}`;
            }, 1000);
        } else { clearInterval(timerInterval); timerInterval = null; document.getElementById('btn-start').style.display = "inline-block"; document.getElementById('btn-stop').style.display = "none"; document.getElementById('stopwatch').innerText = "00:00:00"; }
    }

    function renderDashboard() {
        const now = new Date();
        const monthH = db.entries.filter(e => new Date(e.date).getMonth() === now.getMonth()).reduce((s,e) => s + e.total, 0);
        document.getElementById('dash-summary-content').innerHTML = `<div style="background:var(--accent); padding:15px; border-radius:12px; text-align:center; margin-bottom:15px;"><small>Aktueller Monat</small><div style="font-size:1.8rem; font-weight:bold;">${monthH.toFixed(2)} h</div><div>= ${(monthH * db.wage).toFixed(2)} â‚¬</div></div>`;
        document.getElementById('tour-list').innerHTML = db.tours.map(t => `<div style="display:flex;justify-content:space-between;padding:5px;border-bottom:1px solid #333;">${t} <span onclick="deleteTour('${t}')" style="color:var(--danger);cursor:pointer;">âœ•</span></div>`).join('');
    }

    function renderReport() {
        let html = ''; const weeks = {};
        db.entries.forEach(e => { const key = `KW ${e.kw} | ${e.tour}`; if(!weeks[key]) weeks[key] = { items: [], h: 0 }; weeks[key].items.push(e); weeks[key].h += e.total; });
        for(let k in weeks) {
            html += `<div class="week-block"><div class="week-title">${k}</div><table class="report-table"><thead><tr><th>Datum</th><th>Vorm.</th><th>Nachm.</th><th>Std.</th><th></th></tr></thead><tbody>${weeks[k].items.map(i => `<tr><td>${new Date(i.date).toLocaleDateString('de-DE')}</td><td>${i.am_s}-${i.am_e}</td><td>${i.pm_s}-${i.pm_e}</td><td>${i.total.toFixed(2)}</td><td style="text-align:right"><span onclick="copyEntry(${i.id})" style="color:var(--accent);margin-right:10px;cursor:pointer;">â§‰</span><span onclick="editEntry(${i.id})" style="color:var(--edit);margin-right:10px;cursor:pointer;">âœŽ</span><span onclick="deleteEntry(${i.id})" style="color:var(--danger);cursor:pointer;">ðŸ—‘</span></td></tr>`).join('')}</tbody></table><div style="padding:10px; font-size:0.8rem; font-weight:bold;">Summe Woche: ${weeks[k].h.toFixed(2)}h (= ${(weeks[k].h * db.wage).toFixed(2)} â‚¬)</div></div>`;
        }
        document.getElementById('report-list').innerHTML = html || "Keine EintrÃ¤ge.";
    }

    async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const monate = ["Januar", "Februar", "MÃ¤rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
    let y = 20;

    const checkPage = (needed) => { 
        if (y + needed > 275) { 
            pdf.addPage(); 
            y = 20; 
            return true; 
        } 
        return false; 
    };

    // Header fixieren
    pdf.setFillColor(230, 230, 230); pdf.rect(15, y, 180, 12, 'F');
    pdf.setFontSize(16); pdf.setFont("helvetica", "bold");
    pdf.text("Stundennachweis Busbetrieb Elkmann", 105, y + 8, { align: "center" });
    y += 18;
    
    pdf.setFontSize(10); pdf.setFont("helvetica", "normal");
    pdf.text(`Fahrer: Frank Berndt | Sellen 22 | 48565 Steinfurt`, 15, y);
    y += 10;

    // Daten nach Monat gruppieren
    const grouped = {};
    db.entries.forEach(e => {
        const d = new Date(e.date);
        const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        if (!grouped[monthKey]) grouped[monthKey] = [];
        grouped[monthKey].push(e);
    });

    // Monate sortiert abarbeiten
    const sortedMonths = Object.keys(grouped).sort().reverse();

    sortedMonths.forEach(monthKey => {
        const [year, month] = monthKey.split('-');
        const monthName = monate[parseInt(month) - 1];
        
        checkPage(30);
        // Monats-Header
        pdf.setFillColor(114, 137, 218); // Dein Accent-Blau
        pdf.setTextColor(255, 255, 255);
        pdf.rect(15, y, 180, 8, 'F');
        pdf.setFont("helvetica", "bold");
        pdf.text(`${monthName} ${year}`, 18, y + 5.5);
        pdf.setTextColor(0, 0, 0);
        y += 12;

        // EintrÃ¤ge dieses Monats
        let monthTotalH = 0;
        grouped[monthKey].forEach(i => {
            checkPage(10);
            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(9);
            
            const dateStr = new Date(i.date).toLocaleDateString('de-DE');
            pdf.text(dateStr, 18, y);
            pdf.setFont("helvetica", "bold");
            pdf.text(i.tour, 45, y);
            pdf.setFont("helvetica", "normal");
            
            pdf.text(`${i.am_s}-${i.am_e}`, 100, y);
            pdf.text(`${i.pm_s}-${i.pm_e}`, 130, y);
            pdf.text(`${i.total.toFixed(2)} h`, 175, y);
            
            pdf.setDrawColor(200);
            pdf.line(15, y + 2, 195, y + 2);
            
            monthTotalH += i.total;
            y += 8;
        });

        // Monats-Summe
        pdf.setFont("helvetica", "bold");
        pdf.text(`Summe ${monthName}: ${monthTotalH.toFixed(2)} h | ${(monthTotalH * db.wage).toFixed(2)} â‚¬`, 193, y + 2, {align: "right"});
        y += 15;
    });

    // Unterschriften-Feld am Ende des Dokuments
    if (y > 250) { pdf.addPage(); y = 20; } else { y = 265; }
    pdf.setFontSize(8);
    pdf.line(15, y, 80, y); pdf.line(120, y, 185, y);
    pdf.text("Unterschrift Frank Berndt", 15, y + 5); 
    pdf.text("BestÃ¤tigung Betrieb", 120, y + 5);

    pdf.save(`Abrechnung_Frank_Berndt.pdf`);
}

    function showTab(id) { document.querySelectorAll('.container').forEach(c => c.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).classList.add('active'); document.getElementById('nav-' + id.split('-')[1]).classList.add('active'); if(id === 'tab-report') renderReport(); if(id === 'tab-dash') renderDashboard(); }
    function updateTourDropdowns() { const options = db.tours.map(t=>`<option value="${t}">${t}</option>`).join(''); document.getElementById('sel-tour').innerHTML = options; document.getElementById('timer-tour-sel').innerHTML = options; }
    function addTour() { const n = document.getElementById('new-tour-name').value.trim(); if(n && !db.tours.includes(n)) { db.tours.push(n); saveDB(); init(); } }
    function deleteTour(n) { if(confirm("LÃ¶schen?")) { db.tours=db.tours.filter(t=>t!==n); saveDB(); init(); } }
    function getKW(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(),0,1))) / 86400000) + 1)/7); }
    function saveEntry() {
        const am_s = document.getElementById('am-s').value, am_e = document.getElementById('am-e').value, pm_s = document.getElementById('pm-s').value, pm_e = document.getElementById('pm-e').value;
        const calc = (s, e) => (new Date(`1970-01-01T${e}`) - new Date(`1970-01-01T${s}`)) / 3600000;
        const total = Math.max(0, calc(am_s, am_e)) + Math.max(0, calc(pm_s, pm_e));
        const data = { id: editId || Date.now(), tour: document.getElementById('sel-tour').value, date: document.getElementById('in-date').value, kw: getKW(new Date(document.getElementById('in-date').value)), am_s, am_e, pm_s, pm_e, total };
        if(editId) db.entries[db.entries.findIndex(e=>e.id===editId)] = data; else db.entries.push(data);
        db.entries.sort((a,b) => new Date(a.date) - new Date(b.date)); saveDB(); resetForm(); showTab('tab-report');
    }
    function copyEntry(id) { const e = db.entries.find(x=>x.id===id); document.getElementById('sel-tour').value = e.tour; document.getElementById('in-date').valueAsDate = new Date(); document.getElementById('am-s').value = e.am_s; document.getElementById('am-e').value = e.am_e; document.getElementById('pm-s').value = e.pm_s; document.getElementById('pm-e').value = e.pm_e; editId = null; showTab('tab-entry'); }
    function editEntry(id) { const e = db.entries.find(x=>x.id===id); editId=id; document.getElementById('sel-tour').value=e.tour; document.getElementById('in-date').value=e.date; document.getElementById('am-s').value=e.am_s; document.getElementById('am-e').value=e.am_e; document.getElementById('pm-s').value=e.pm_s; document.getElementById('pm-e').value=e.pm_e; showTab('tab-entry'); document.getElementById('btn-cancel').style.display="block"; }
    function deleteEntry(id) { if(confirm("LÃ¶schen?")) { db.entries=db.entries.filter(x=>x.id!==id); saveDB(); renderReport(); } }
    function resetForm() { editId = null; document.getElementById('btn-cancel').style.display="none"; }
    function exportCSV() {
        let csv = "Datum;Tour;Std;Betrag\n";
        db.entries.forEach(e => csv += `${e.date};${e.tour};${e.total.toFixed(2)};${(e.total*db.wage).toFixed(2)}\n`);
        const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob(["\ufeff"+csv], {type:'text/csv'})); link.download = "Export.csv"; link.click();
    }
    init();
</script>
</body>
</html>
